<mat-card class="card-gradient-header card-hover mt-4">
  <mat-card-header class="flex justify-content-center">
    <div>
      <mat-card-title class="flex justify-content-center font-medium text-2xl">Firma Digital</mat-card-title>
      <mat-card-subtitle class="flex justify-content-center">Finalización del proceso crediticio</mat-card-subtitle>
    </div>
  </mat-card-header>

  <mat-card-content>

    <!-- Visor de PDF -->
    <div class="pdf-viewer-container">
        <h4 class="text-secondary">Documento para Firma</h4>

        <div *ngIf="cargandoPDF" class="pdf-loading">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Cargando documento...</p>
        </div>

        <div *ngIf="errorCargaPDF" class="pdf-error">
          <mat-icon color="warn">error</mat-icon>
          <p>Error al cargar el documento. Por favor, intente nuevamente.</p>
          <button mat-raised-button color="primary" (click)="cargarPDF()">
            Reintentar
          </button>
        </div>

        <iframe *ngIf="pdfUrl && !cargandoPDF && !errorCargaPDF" [src]="pdfUrl" class="pdf-viewer" frameborder="0">
        </iframe>
      </div>

      <!-- Sección de validación OTP -->
      <div class="otp-section">
        <h4 class="text-secondary">Código de Verificación para Firma</h4>
        <p class="otp-info">Ingresa el código de 6 dígitos enviado a tu celular</p>

        <!-- Información de envío -->
        <div class="send-info">
          <p><mat-icon>sms</mat-icon> <strong>SMS:</strong> {{ getCelularMask() }}</p>
        </div>

        <!-- 6 Inputs OTP Individuales -->
        <div class="otp-visual-container" (click)="focusInput()">
          <!-- Input real, pero oculto. Gestiona toda la lógica. -->
          <input #hiddenInput type="tel" class="hidden-otp-input" maxlength="6" [ngModel]="otpCode"
            (ngModelChange)="onCodeChanged($event)" pattern="\d*" inputmode="numeric" autocomplete="one-time-code" />

          <!-- Contenedor para los dígitos visuales -->
          <div class="otp-visual-inputs">
            <div *ngFor="let digit of displayDigits; let i = index" class="otp-digit" [class.filled]="digit"
              [class.cursor]="i === otpCode.length && hiddenInput.matches(':focus')">
              {{ digit }}
            </div>
          </div>
        </div>

        <!-- Estado de validación -->
        <div class="validation-status" *ngIf="isValidating">
          <mat-icon class="spin">sync</mat-icon>
          <span>Verificando código...</span>
        </div>

        <!-- Botones de acción OTP -->
        <div class="otp-actions">
          <button mat-stroked-button color="accent" (click)="clearOtp()" [disabled]="isValidating">
            <mat-icon>clear</mat-icon>
            Limpiar
          </button>

          <button mat-raised-button color="primary" (click)="validateOtp()" [disabled]="otpCode.length !== 6 || isValidating">
            <mat-icon *ngIf="!isValidating">check_circle</mat-icon>
            <mat-icon *ngIf="isValidating" class="spin">sync</mat-icon>
            {{isValidating ? 'Validando...' : 'Validar y Continuar'}}
          </button>
        </div>
      </div>

  </mat-card-content>
</mat-card>
