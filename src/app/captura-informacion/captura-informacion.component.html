<mat-card class="card-gradient-header card-hover mt-4">
  <mat-card-header class="flex justify-content-center">
    <div>
      <mat-card-title class="flex justify-content-center font-medium text-2xl">Información Personal y Financiera</mat-card-title>
      <mat-card-subtitle class="flex justify-content-center">Complete los siguientes campos requeridos</mat-card-subtitle>
    </div>
  </mat-card-header>

  <mat-card-content>
    <form class="formulario-captura" [formGroup]="formularioPrincipal">

      <!-- Información Personal -->
      <div class="seccion-formulario">
        <h4 class="titulo-seccion">
          <mat-icon>person</mat-icon>
          Información Personal
          <small *ngIf="cargandoCiudades" style="margin-left: 10px; color: #666;">
            (Cargando ciudades...)
          </small>
        </h4>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Tipo de identificación</mat-label>
            <mat-select formControlName="tipoIdentificacion" required>
              <mat-option value="CC">Cédula de Ciudadanía</mat-option>
              <mat-option value="CE">Cédula de Extranjería</mat-option>
              <mat-option value="PA">Pasaporte</mat-option>
              <mat-option value="TI">Tarjeta de Identidad</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Identificación</mat-label>
            <input matInput formControlName="identificacion" required placeholder="Número de identificación">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Sexo</mat-label>
            <mat-select formControlName="sexo" required>
              <mat-option value="M">Masculino</mat-option>
              <mat-option value="F">Femenino</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Primer nombre</mat-label>
            <input matInput formControlName="primerNombre" required placeholder="Primer nombre">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Segundo nombre</mat-label>
            <input matInput formControlName="segundoNombre" required placeholder="Segundo nombre">
          </mat-form-field>
        </div>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Primer apellido</mat-label>
            <input matInput formControlName="primerApellido" required placeholder="Primer apellido">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Segundo apellido</mat-label>
            <input matInput formControlName="segundoApellido" required placeholder="Segundo apellido">
          </mat-form-field>
        </div>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Fecha de expedición</mat-label>
            <input matInput type="date" formControlName="fechaExpedicion" required placeholder="MM/DD/YYYY">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Ciudad expedición documento</mat-label>
            <input matInput
                   [formControl]="ciudadExpedicionControl"
                   [matAutocomplete]="autoExpedicion"
                   placeholder="Buscar ciudad...">
            <mat-autocomplete #autoExpedicion="matAutocomplete"
                              [displayWith]="displayCiudad"
                              (optionSelected)="onCiudadSeleccionada($event.option.value, 'expedicion')">
              <mat-option *ngFor="let ciudad of ciudadesExpedicion | async" [value]="ciudad">
                {{ ciudad.ciudad }} - {{ ciudad.departamento }}
              </mat-option>
            </mat-autocomplete>
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Estado civil</mat-label>
            <mat-select formControlName="estadoCivil" required>
              <mat-option value="S">Soltero(a)</mat-option>
              <mat-option value="C">Casado(a)</mat-option>
              <mat-option value="U">Unión libre</mat-option>
              <mat-option value="D">Divorciado(a)</mat-option>
              <mat-option value="V">Viudo(a)</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Fecha de nacimiento</mat-label>
            <input matInput type="date" formControlName="fechaNacimiento" required placeholder="MM/DD/YYYY">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Ciudad de nacimiento</mat-label>
            <input matInput
                   [formControl]="ciudadNacimientoControl"
                   [matAutocomplete]="autoNacimiento"
                   placeholder="Buscar ciudad...">
            <mat-autocomplete #autoNacimiento="matAutocomplete"
                              [displayWith]="displayCiudad"
                              (optionSelected)="onCiudadSeleccionada($event.option.value, 'nacimiento')">
              <mat-option *ngFor="let ciudad of ciudadesNacimiento | async" [value]="ciudad">
                {{ ciudad.ciudad }} - {{ ciudad.departamento }}
              </mat-option>
            </mat-autocomplete>
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Dirección de residencia</mat-label>
            <input matInput formControlName="direccionResidencia" required placeholder="Dirección completa de residencia">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Ciudad de residencia</mat-label>
            <input matInput
                   [formControl]="ciudadResidenciaControl"
                   [matAutocomplete]="autoResidencia"
                   required
                   placeholder="Buscar ciudad...">
            <mat-autocomplete #autoResidencia="matAutocomplete"
                              [displayWith]="displayCiudad"
                              (optionSelected)="onCiudadSeleccionada($event.option.value, 'residencia')">
              <mat-option *ngFor="let ciudad of ciudadesResidencia | async" [value]="ciudad">
                {{ ciudad.ciudad }} - {{ ciudad.departamento }}
              </mat-option>
            </mat-autocomplete>
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Teléfono residencia</mat-label>
            <input matInput type="tel" formControlName="telefonoResidencia" required placeholder="Teléfono de residencia">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Móvil</mat-label>
            <input matInput type="tel" formControlName="movil" required placeholder="Teléfono móvil">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" required placeholder="correo@ejemplo.com">
          </mat-form-field>
        </div>
      </div>

      <!-- Información Laboral -->
      <div class="seccion-formulario">
        <h4 class="titulo-seccion">
          <mat-icon>work</mat-icon>
          Información Laboral
        </h4>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Sitio de trabajo</mat-label>
            <input matInput formControlName="sitioTrabajo" required placeholder="Nombre de la empresa o sitio de trabajo">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Cargo</mat-label>
            <input matInput formControlName="cargo" required placeholder="Cargo que desempeña">
          </mat-form-field>
        </div>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Dirección de trabajo</mat-label>
            <input matInput formControlName="direccionTrabajo" required placeholder="Dirección completa del trabajo">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Ciudad de trabajo</mat-label>
            <input matInput
                   [formControl]="ciudadTrabajoControl"
                   [matAutocomplete]="autoTrabajo"
                   required
                   placeholder="Buscar ciudad...">
            <mat-autocomplete #autoTrabajo="matAutocomplete"
                              [displayWith]="displayCiudad"
                              (optionSelected)="onCiudadSeleccionada($event.option.value, 'trabajo')">
              <mat-option *ngFor="let ciudad of ciudadesTrabajo | async" [value]="ciudad">
                {{ ciudad.ciudad }} - {{ ciudad.departamento }}
              </mat-option>
            </mat-autocomplete>
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Teléfono trabajo</mat-label>
            <input matInput type="tel" formControlName="telefonoTrabajo" required placeholder="Teléfono del trabajo">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Tipo de contrato</mat-label>
            <mat-select formControlName="tipoContrato" required>
              <mat-option value="INDEFINIDO">Indefinido</mat-option>
              <mat-option value="DEFINIDO">Definido</mat-option>
              <mat-option value="PRESTACION">Prestación de servicios</mat-option>
              <mat-option value="INDEPENDIENTE">Independiente</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-tercio">
            <mat-label>Salario</mat-label>
            <span matTextPrefix>$ </span>
            <input matInput
                   type="text"
                   formControlName="salario"
                   required
                   placeholder="0.00"
                   (input)="formatCurrency($event, 'salario')"
                   (blur)="formatCurrencyOnBlur($event, 'salario')"
                   pattern="[0-9,.]+"
                   title="Ingrese solo números">
            <span matTextSuffix> COP</span>
          </mat-form-field>
        </div>
      </div>

      <!-- Información Adicional -->
      <div class="seccion-formulario">
        <h4 class="titulo-seccion">
          <mat-icon>business</mat-icon>
          Información Adicional Requerida
        </h4>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-completo">
            <mat-label>Código oficina</mat-label>
            <input matInput formControlName="codOficina" required placeholder="Código de oficina">
          </mat-form-field>
        </div>
      </div>

      <!-- Campos Opcionales -->
      <div class="seccion-formulario">
        <h4 class="titulo-seccion">
          <mat-icon>monetization_on</mat-icon>
          Información Financiera (Opcional)
        </h4>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Valor aporte</mat-label>
            <span matTextPrefix>$ </span>
            <input matInput
                   type="text"
                   formControlName="valorAporte"
                   placeholder="0.00"
                   (input)="formatCurrency($event, 'valorAporte')"
                   (blur)="formatCurrencyOnBlur($event, 'valorAporte')"
                   pattern="[0-9,.]+"
                   title="Ingrese solo números">
            <span matTextSuffix> COP</span>
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Periodicidad</mat-label>
            <mat-select formControlName="periodicidad">
              <mat-option value="MENSUAL">Mensual</mat-option>
              <mat-option value="QUINCENAL">Quincenal</mat-option>
              <mat-option value="SEMANAL">Semanal</mat-option>
              <mat-option value="ANUAL">Anual</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="campos-row">
          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Fecha próximo pago</mat-label>
            <input matInput type="date" formControlName="fechaProximoPago" placeholder="MM/DD/YYYY">
          </mat-form-field>

          <mat-form-field appearance="outline" class="campo-medio">
            <mat-label>Forma de pago</mat-label>
            <mat-select formControlName="formaPago">
              <mat-option value="EFECTIVO">Efectivo</mat-option>
              <mat-option value="TRANSFERENCIA">Transferencia</mat-option>
              <mat-option value="CHEQUE">Cheque</mat-option>
              <mat-option value="DEBITO_AUTOMATICO">Débito automático</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Información Complementaria (Campos Dinámicos) -->
      <div class="seccion-formulario" [formGroup]="camposDinamicosForm">
        <h4 class="titulo-seccion">
          <mat-icon>dynamic_form</mat-icon>
          Información Complementaria
          <small *ngIf="cargandoCamposDinamicos" style="margin-left: 10px; color: #666;">
            (Cargando campos...)
          </small>
        </h4>

        <!-- Mostrar mensaje si no hay campos -->
        <div *ngIf="!cargandoCamposDinamicos && camposDinamicos.length === 0" class="no-campos-dinamicos">
          <p style="text-align: center; color: #666; font-style: italic;">
            No hay campos complementarios configurados para esta entidad.
          </p>
        </div>

        <!-- Renderizar campos dinámicos -->
        <div *ngFor="let campo of camposDinamicos" class="campo-dinamico-container">

          <!-- DROPDOWN - Cuando tiene registrosTablaMaestra -->
          <mat-form-field
            *ngIf="campo.tipo === TipoCampoDinamico.DROPDOWN"
            appearance="outline"
            class="campo-completo">
            <mat-label>{{ campo.descripcion }}</mat-label>
            <mat-select
              [formControlName]="campo.campo"
              [required]="campo.required"
              (selectionChange)="onCampoDinamicoSeleccionado(campo, $event.value)">
              <mat-option
                *ngFor="let registro of campo.registrosTablaMaestra"
                [value]="registro.Codigo">
                {{ registro.Detalle }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="hasCampoDinamicoError(campo.campo)">
              {{ campo.descripcion }} es requerido
            </mat-error>
          </mat-form-field>

          <!-- CAMPO FECHA - Cuando tipo es FECHA -->
          <mat-form-field
            *ngIf="campo.tipo === TipoCampoDinamico.FECHA"
            appearance="outline"
            class="campo-medio">
            <mat-label>{{ campo.descripcion }}</mat-label>
            <input
              matInput
              type="date"
              [formControlName]="campo.campo"
              [required]="campo.required"
              placeholder="Seleccione fecha">
            <mat-error *ngIf="hasCampoDinamicoError(campo.campo)">
              {{ campo.descripcion }} es requerido
            </mat-error>
          </mat-form-field>

          <!-- CAMPO NÚMERO - Cuando tipo es NUMERO -->
          <mat-form-field
            *ngIf="campo.tipo === TipoCampoDinamico.NUMERO"
            appearance="outline"
            class="campo-medio">
            <mat-label>{{ campo.descripcion }}</mat-label>
            <input
              matInput
              type="number"
              [formControlName]="campo.campo"
              [required]="campo.required"
              placeholder="Ingrese valor numérico"
              min="0"
              step="0.01">
            <mat-error *ngIf="hasCampoDinamicoError(campo.campo)">
              {{ campo.descripcion }} es requerido
            </mat-error>
          </mat-form-field>

          <!-- CAMPO TEXTO - Por defecto o cuando tipo es TEXTO -->
          <mat-form-field
            *ngIf="campo.tipo === TipoCampoDinamico.TEXTO"
            appearance="outline"
            class="campo-completo">
            <mat-label>{{ campo.descripcion }}</mat-label>
            <input
              matInput
              type="text"
              [formControlName]="campo.campo"
              [required]="campo.required"
              [placeholder]="'Ingrese ' + campo.descripcion.toLowerCase()">
            <mat-error *ngIf="hasCampoDinamicoError(campo.campo)">
              {{ campo.descripcion }} es requerido
            </mat-error>
          </mat-form-field>

        </div>

        <!-- TODO: Información de ayuda para backend -->
        <!--
        PALABRAS CLAVE PARA TIPOS DE CAMPO (ajustar desde backend si es necesario):

        FECHA:
        - "fecha", "ingreso laboral"

        NUMERO:
        - "numero", "valor", "ingreso", "salario", "monto"

        Por defecto: TEXTO
        -->

      </div>

    </form>

  </mat-card-content>

  <mat-card-actions class="otp-actions">
    <button mat-raised-button color="primary" (click)="onContinuar()">
      <mat-icon>save</mat-icon>
      Guardar información
    </button>
  </mat-card-actions>
</mat-card>
